#!/usr/bin/env node
import fs from "node:fs";
import path from "node:path";

const hooksDir = path.resolve(".git", "hooks");
const hookPath = path.join(hooksDir, "pre-commit");
const defaultCommand = "npm run cli -- precommit --staged --baseline nullid.policy.json --threshold high";
const userCommand = process.argv.slice(2).join(" ").trim();
const command = userCommand || defaultCommand;

if (!fs.existsSync(hooksDir)) {
  console.error("[precommit] .git/hooks directory not found. Run inside the repository root.");
  process.exit(1);
}

const nextContent = `#!/bin/sh
# NullID pre-commit hook (generated by scripts/install-precommit.mjs)
set -e
${command}
`;

if (fs.existsSync(hookPath)) {
  const current = fs.readFileSync(hookPath, "utf8");
  if (current !== nextContent) {
    const backupPath = `${hookPath}.bak`;
    fs.writeFileSync(backupPath, current, "utf8");
    console.log(`[precommit] existing hook backed up to ${path.relative(process.cwd(), backupPath)}`);
  }
}

fs.writeFileSync(hookPath, nextContent, "utf8");
fs.chmodSync(hookPath, 0o755);
console.log(`[precommit] installed ${path.relative(process.cwd(), hookPath)}`);
console.log(`[precommit] command: ${command}`);
